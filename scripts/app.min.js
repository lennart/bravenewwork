/**
 * audiowalk
 * @version v0.1.0 - 2014-07-22
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","LocalStorageModule","ngTouch","ngSanitize","duScroll","leaflet-directive"]),debug=!1;app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider","$logProvider","$provide",function(e,i,a,n){n.value("debugMode",debug),a.debugEnabled(debug),i.when("/",{templateUrl:"views/start.html"}).when("/credits",{templateUrl:"views/credits.html"}).when("/:slide?",{templateUrl:"views/slide.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log","localStorageService","$window","ApplicationCache",function(e,i,a,n,t,o){e.online=navigator.onLine,o.init(),t.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),t.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1)}]),app.controller("MainCtrl",["$scope","$location","version","$log","$window","Places","$routeParams","$rootScope","localStorageService","Audio","Geolocation",function(e,i,a,n,t,o,d,s,r,c,l){e.updateCurrentSlide=function(i){n.debug("updating current slide",i),e.currentSlide=o.idToSlideIndex(i),e.slide=o.slides[e.currentSlide],e.$index=e.currentSlide,e.nextSlideId=o.indexToSlideId(e.currentSlide+1),e.nextSlide=o.slides[e.currentSlide+1],e.prevSlideId=o.indexToSlideId(e.currentSlide-1),s.currentSlideId=e.slide.id,n.debug("[main] slide change",{current:e.slide.id,next:e.nextSlideId,prev:e.prevSlideId})},s.$on("$routeChangeSuccess",function(a,t){"/"===i.path()?n.info("[main] start me up"):(e.updateCurrentSlide(t.params.slide),o.slides.length-1===e.currentSlide?r.set("finished","yes"):n.info("[main] yet another slide:",e.currentSlideId))}),s.$on("$routeChangeStart",function(){l.unwatch()}),e.changeSlide=function(e){i.path(e).replace(),s.$apply()},e.$watch("online",function(e){e?t.ga("send","event","system","change","online"):t.ga("send","event","system","change","offline")})}]),app.controller("StartCtrl",["$scope","$timeout","debugMode","ApplicationCache","$location","version","$log","$window","Places","$routeParams","$rootScope","localStorageService","$document","$element","Audio",function(e,i,a,n,t,o,d,s,r,c,l,u,p,g,h){e.$path=t.path.bind(t),e.version=o,e.appReady=function(i,n){d.info("[app] ready because:",n),a?p.find("body").click(function(){e.loading=!1,e.loaded=!0,e.$apply()}):(e.loading=!1,e.loaded=!0)},e.appLoading=function(i,a){e.loading=!0,d.info("[app] caching progress",a),e.cachedPercentage=a.percentage,e.scrollingIntro||(e.scrollingIntro=!0,e.scrollIntro())},e.$on("app:ready",e.appReady),e.trackStartClick=function(){s.ga("send","event","button","click","start button"),d.info("Tracking click to start App")},l.$on("cache:ready",e.appReady),l.$on("cache:loading",e.appLoading),e.firstSlide=r.slides[0].id,e.credits=!1,e.loading=!1,e.loaded=!1,e.toggleCredits=function(){e.credits=e.credits===!1?!0:!1,e.credits===!0&&i(function(){p.scrollToElement(g.find("#credits-block"),s.screen.availHeight,5e4,function(e){return.5>e?2*e*e:-1+(4-2*e)*e}).then(function(){d.debug("no more scrolling credits")})})},h.set("credits","/audio/way/n.mp3"),h.pauseAll(),l.currentSound&&l.currentSound.stop(),e.scrollIntro=function(){i(function(){var e=g.find("#loading-bar-block");e.length&&p.scrollToElement(e,s.screen.availHeight-100,25e3,function(e){return.5>e?2*e*e:-1+(4-2*e)*e}).then(function(){d.info("intro scrolling finished")})})},"yes"==u.get("finished")?(u.set("finished","no"),d.info("[start] finished",u.get("finished")),h.play("credits"),i(function(){e.toggleCredits()},100),e.$emit("app:ready")):n.isLoading()?d.info("[app] caching resources"):(d.info("[app] go!"),e.$emit("app:ready","resume"))}]),app.controller("PlacesCtrl",["debugMode","$rootScope","$scope","$sce","$routeParams","Places","$log","$window","$element","$location","$timeout","Geolocation","$document","Audio",function(e,i,a,n,t,o,d,s,r,c,l,u,p,g){if(a.debugMode=e,a.$on("map:destination:reached",function(){d.info("[places] destination reached, vibrating, awareness, now!"),navigator.vibrate&&navigator.vibrate(1e3),a.notice="Ziel erreicht!",a.showNotice=!0,l(function(){d.debug("[places] hide destination notice"),a.showNotice=!1},5e3),a.$emit("slide:change:request")}),a.$on("slide:change:request",function(){d.info("[places] wants to change slide"),a.destinationReached&&a.soundEnded?(a.changeSlide(a.nextSlide?a.nextSlide.id:""),a.resetAutoChange()):d.info(a.destinationReached?"but first lets hear that sound till the end!":"but first we have to get to the destination!")}),a.$on("change:distance",function(e,i){d.debug("[places] changed distance",arguments),l(function(){a.slide.distance=i},500)}),a.trackNextClick=function(){d.info("[tracking] next click"),s.ga("send","event","button","click","next slide")},a.trackPrevClick=function(){d.info("[tracking] prev click"),s.ga("send","event","button","click","prev slide")},a.trackPlayClick=function(){d.info("[tracking] play click"),s.ga("send","event","button","click","play slide")},a.trackPauseClick=function(){d.info("[tracking] pause click"),s.ga("send","event","button","click","pause slide")},a.resetAutoChange=function(){a.destinationReached=!1,a.soundEnded=!1},a.toggleAudio=function(){if(a.slide.audio){var e=g.audios[a.slide.id];d.debug("current audio",e),a.playing(a.slide.id)?(a.trackPauseClick(),e.pause()):(a.trackPlayClick(),e.play())}},a.jumpToEndOfAudio=function(){if(a.slide.audio){var e=g.audios[a.slide.id];e.isPaused()||e.setPercent(98)}},a.watchUserPosition=function(){d.info("[map] watching movements"),i.$on("geolocation:changed",function(e,i){if(a.destinationReached)d.debug("[places] geolocation already reached, cease distance calc");else{{o.slides[a.currentSlide]}if(a.slide.maps&&a.slide.maps.destination&&a.slide.maps.destination.latitude&&a.slide.maps.destination.longitude){d.debug(i.coords.latitude,i.coords.longitude,a.slide.maps.destination.latitude,a.slide.maps.destination.longitude);var n=u.distanceInKm(i.coords.latitude,i.coords.longitude,a.slide.maps.destination.latitude,a.slide.maps.destination.longitude);d.debug("distance",n),a.slide.destination_distance=Math.round(1e3*n*100)/100,a.$emit("change:distance",a.slide.destination_distance),.015>n?(d.debug("reached!",a.currentSlideId,a.nextSlide.id),a.destinationReached=!0,u.unwatch(),a.$emit("map:destination:reached")):d.debug("the waypoint is ",n,"away!")}else d.info("no destination")}}),i.$on("geolocation:error",function(e,i){d.error("Failed watching position",i)}),u.watch()},a.playing=g.playing,a.showNotice=!1,a.currentSlideNumber=a.$index+1,a.totalSlides=Object.keys(o.slides).length,g.pauseAll(),u.unwatch(),a.slide.maps?(a.watchUserPosition(),u.current().then(function(e){d.debug("current position",e),i.$emit("geolocation:changed",e)}).catch(function(e){d.error("Failed to read current Position",e)})):(a.destinationReached=!0,u.unwatch()),a.slide.audio){var h=g.audios[a.slide.id];h.bindOnce("ended",function(){a.soundEnded=!0,a.$emit("slide:change:request")}),h.play()}else a.soundEnded=!0}]),app.controller("MapCtrl",["$rootScope","$scope","$location","$log","leafletData",function(e,i,a,n,t){angular.extend(i,{defaults:{tileLayer:a.protocol()+"://"+a.host()+":"+a.port()+"/tiles/{z}/{x}/{y}.png",maxZoom:18,minZoom:16,tileLayerOptions:{attribution:"Data © OpenStreetMap (and) contributors, CC-BY-SA",maxZoom:18,maxNativeZoom:18}},center:{lat:52.5299522,lng:13.4010189,zoom:18},maxbounds:{southWest:{lng:13.3957,lat:52.5252},northEast:{lng:13.4159,lat:52.5315}},events:{map:{enable:["layeradd","drag","click","zoomstart"],logic:"emit"}}}),i.$on("leafletDirectiveMap.layeradd",function(){}),i.$on("leafletDirectiveMap.zoomstart",function(e,i){n.debug("[map] zooming",e,i)}),t.getMap().then(function(e){var a=L.geoJson(null,{style:function(e){return"LineString"===e.geometry.type?(n.debug("[map] styling",e),{color:"#168",opacity:1,dashArray:"10,10"}):{}},pointToLayer:function(e,i){n.debug("marker",i);var a=L.circleMarker(i,{color:"#813",opacity:.8,fillOpacity:.8,fillColor:"#f45",dashArray:null}).setRadius(7);return a.bindLabel(e.properties.name,{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"})}}),t=i.slide.maps.route,o=omnivore.gpx(t,null,a).on("ready",function(){n.info("labelled route"),e.fitBounds(o.getBounds().pad(10))}).addTo(e)}),e.$on("geolocation:changed",function(e,i){t.getMap().then(function(e){var a=L.latLng(i.coords.latitude,i.coords.longitude),n=L.circleMarker(a,{color:"#318",opacity:.8,fillOpacity:.8,fillColor:"#45f",dashArray:null}).setRadius(7);n.bindLabel("Ich",{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"}).addTo(e)})})}]),app.service("Geolocation",["$rootScope","$window","$q","$log",function(e,i,a,n){function t(e){return e*(Math.PI/180)}var o=this,d=null;this.supportGeolocation=!!i.navigator,this.current=function(){var e=a.defer();return o.supportGeolocation?i.navigator.geolocation.getCurrentPosition(function(i){e.resolve(i)},function(i){e.reject(i)},{enableHighAccuracy:!0}):e.reject({message:"Device does not support Geolocation"}),e.promise},this.watch=function(){o.supportGeolocation?d=i.navigator.geolocation.watchPosition(function(i){e.$emit("geolocation:changed",i)},function(i){e.$emit("geolocation:error",i)},{enableHighAccuracy:!0}):e.$emit("geolocation:error","device does not support geolocation")},this.unwatch=function(){d&&(n.info("[geo] do not care about movements anymore"),i.navigator.geolocation.clearWatch(d))},this.distanceInKm=function(e,i,a,n){var o=6371,d=t(a-e),s=t(n-i),r=Math.sin(d/2)*Math.sin(d/2)+Math.cos(t(e))*Math.cos(t(a))*Math.sin(s/2)*Math.sin(s/2),c=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),l=o*c;return l}}]),app.value("StoryBoard",function(){return[{id:"st-oberholz",caption:"St. Oberholz",audio:"/audio/1.mp3",image:"/images/places/stoberholz.jpg"},{id:"ausland",caption:"Weg zum Haus aus einem anderen Land",maps:{destination:{latitude:52.53109,longitude:13.40011},route:"/maps/a.gpx",image:"/images/routes/1.png"},audio:"/audio/way/a.mp3",autoplay:!0},{id:"haus-aus-einem-anderen-land",caption:"Haus aus einem anderen Land",audio:"/audio/2.mp3",image:"/images/places/haus_aus_einem_anderen_land.jpg"},{id:"weg-zum-leihamt",caption:"Weg zum Königlichen Leihamt",maps:{destination:{latitude:52.52857,longitude:13.39634},waypoints:[{location:"Brunnenstraße 10, Berlin, Germany"}],route:"/maps/b.gpx",image:"/images/routes/2.png",zoom:16},audio:"/audio/way/b.mp3",autoplay:!0},{id:"leihamt",caption:"Königliches Leihamt",audio:"/audio/3.mp3",image:"/images/places/leihamt.jpg"},{id:"weg-zum-leerstehenden-haus",caption:"Weg zum Leerstehenden Haus",maps:{destination:{latitude:52.52899,longitude:13.3984},route:"/maps/c.gpx",image:"/images/routes/3.png",waypoints:[{location:"Linienstraße 98, Berlin, Germany"}]},audio:"/audio/way/c.mp3",autoplay:!0},{id:"leerstehendes-haus",caption:"Leerstehendes Haus",audio:"/audio/4.mp3",image:"/images/places/leerstehendes_haus.jpg"},{id:"weg-zum-besetzten-haus",caption:"Weg zum besetzten Haus",maps:{destination:{latitude:52.52894,longitude:13.40288},image:"/images/routes/4.png",route:"/maps/d.gpx",waypoints:[{location:"Linienstraße 86, Berlin, Germany"}]},audio:"/audio/way/d.mp3"},{id:"besetztes-haus",caption:"Besetztes Haus",audio:"/audio/5.mp3",image:"/images/places/besetztes_haus.jpg"},{id:"weg-zum-garnisonsfriedhof",caption:"Weg zum Garnisonsfriedhof",maps:{destination:{latitude:52.52813,longitude:13.4033},image:"/images/routes/5.png",route:"/maps/e.gpx",waypoints:[{location:"Linienstraße 206, Berlin, Germany"}]},audio:"/audio/way/e.mp3"},{id:"garnisonsfriedhof",caption:"Garnisonsfriedhof",audio:"/audio/6.mp3",image:"/images/places/garnisonsfriedhof.jpg"},{id:"weg-zum-centralen-arbeitsnachweis",caption:"Weg zum Centralen Arbeitsnachweis",maps:{destination:{latitude:52.52791,longitude:13.40503},image:"/images/routes/6.png",route:"/maps/f.gpx",waypoints:[{location:"Garnisonsfriedhof, Kleine Rosenthaler Straße, Berlin, Germany"}]},audio:"/audio/way/f.mp3"},{id:"centraler-arbeitsnachweis",caption:"Centraler Arbeitsnachweis",audio:"/audio/7.mp3",image:"/images/places/arbeitsnachweis.jpg"},{id:"weg-zum-wunschgarten",caption:"Weg zum Wunschgarten",maps:{destination:{latitude:52.52744,longitude:13.40585},image:"/images/routes/7.png",route:"/maps/g.gpx",waypoints:[{location:"Gormannstraße 13, Berlin, Germany"}]},audio:"/audio/way/g.mp3"},{id:"wunschgarten",caption:"Wunschgarten",audio:"/audio/8-h-9.mp3",image:"/images/places/wunschgarten.jpg"},{id:"weg-zur-volksbuehne",caption:"Weg zur Volksbühne",maps:{destination:{latitude:52.52593,longitude:13.41102},image:"/images/routes/8.png",route:"/maps/i.gpx",waypoints:[{location:"Mulackstraße 38-41, Berlin, Germany"}]},audio:"/audio/way/i.mp3"},{id:"volksbuehne",caption:"Volksbühne AM Rosa-Luxemburg-Platz",audio:"/audio/10.mp3",image:"/images/places/volksbuehne.jpg"},{id:"weg-zum-arbeiterdenkmal",caption:"Weg zum Arbeiterdenkmal",maps:{destination:{latitude:52.52549,longitude:13.41336},image:"/images/routes/9.png",route:"/maps/k.gpx",waypoints:[{location:"52.527049,13.411903"}]},audio:"/audio/way/k.mp3"},{id:"arbeiterdenkmal",caption:"Arbeiterdenkmal",image:"/images/places/arbeiterdenkmal.jpg",audio:"/audio/11.mp3"},{id:"weg-zum-karl-liebknecht-haus",caption:"Weg zum Karl-Liebknecht-Haus",maps:{destination:{latitude:52.52658,longitude:13.41294},image:"/images/routes/10.png",route:"/maps/l.gpx",waypoints:[{location:"52.525248,13.413445"}]},audio:"/audio/way/l.mp3"},{id:"karl-liebknecht-haus",caption:"Karl-Liebknecht-Haus",audio:"/audio/12.mp3",image:"/images/places/karl-liebknecht-haus.jpg"},{id:"weg-zum-soho-haus",caption:"Weg zum Soho House",maps:{destination:{latitude:52.52689,longitude:13.41518},image:"/images/routes/11.png",route:"/maps/m.gpx",waypoints:[{location:"Kleine Alexanderstraße 28, Berlin, Germany"}]},audio:"/audio/way/m.mp3"},{id:"soho-House",caption:"Soho House",audio:"/audio/13.mp3",image:"/images/places/soho.jpg"}]}),app.factory("Places",["StoryBoard","$log",function(e){var i=e();return{idToSlideIndex:function(e){var a=i.filter(function(i){return i.id==e});return a[0]?i.indexOf(a[0]):0},indexToSlideId:function(e){var a;return(a=i[e])?a.id:null},slides:i}}]),app.service("Audio",["$q","$log","Places","$rootScope","$timeout",function(e,i,a,n,t){var o=this,d=this.audios={};angular.forEach(a.slides,function(e){e.audio&&(d[e.id]=new buzz.sound(e.audio))}),this.set=function(e,i){d[e]=new buzz.sound(i)},this.play=function(e){var i=d[e];return i?(i.play(),i):!1},this.delayedStartStop=function(e,i){i=i||100;var a=d[e];a.play();var n=function(){a.pause()};return t(n,i,!0)},this.ensureAutoplay=function(){var i=(e.defer(),a.slides.filter(function(e){return!!e.audio}).map(function(e){return o.delayedStartStop(e.id,100)}));return e.all(i)},this.pauseAll=function(){return angular.forEach(d,function(e){e.pause()}),!0},this.playing=function(e){var i=d[e];return i?!i.isPaused():!1}}]),app.service("ApplicationCache",["$log","$window","$rootScope",function(e,i,a){var n=this,t={loaded:0,total:0,ready:!1,percentage:0},o=i.applicationCache;this.isAvailable=function(){return!!o},this.isLoading=function(){if(!this.isAvailable())return!1;switch(o.status){case i.applicationCache.IDLE:case i.applicationCache.UNCACHED:return!1;default:return!0}},this.isCached=function(){return this.isAvailable()?o.status===i.applicationCache.IDLE:!1},this.handleEvent=function(i){switch(e.debug("[cache] event",i,n.progress),i.type){case"checking":a.$emit("cache:loading",t);break;case"downloading":a.$emit("cache:loading",t);break;case"error":n.isCached()?(a.$emit("cache:ready","error"),a.$apply()):$location.refresh();break;case"noupdate":t.percentage="100%",a.$emit("cache:ready","noupdate"),a.$apply();break;case"progress":t.percentage=i.loaded/i.total*100+"%",t.total=i.total,t.loaded=i.loaded,a.$emit("cache:loading",t),a.$apply();break;case"cached":t.percentage="100%",a.$emit("cache:ready","cached"),a.$apply(),a.$apply();break;case"updateready":t.percentage="100%",a.$emit("cache:ready","updateready"),a.$apply()}},this.init=function(){this.isAvailable()?(e.info("[cache] application cache available"),o.addEventListener("error",this.handleEvent,!1),o.addEventListener("checking",this.handleEvent,!1),o.addEventListener("noupdate",this.handleEvent,!1),o.addEventListener("downloading",this.handleEvent,!1),o.addEventListener("progress",this.handleEvent,!1),o.addEventListener("updateready",this.handleEvent,!1),o.addEventListener("cached",this.handleEvent,!1)):e.info("[cache] no application cache, no love")}}]);